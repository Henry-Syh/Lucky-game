<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ–ï¸ æ‹–æ›³æ‘¸ç‰Œï¼šäº”è·¯è²¡ç¥</title>
    <style>
        :root {
            --card-w: 56px;
            --card-h: 84px;
            --slot-border: rgba(255, 215, 0, 0.6);
        }

        body {
            font-family: 'Arial', sans-serif;
            background-color: #1a472a; /* æ·±ç¶ è‰² */
            margin: 0;
            padding: 0;
            overflow: hidden; /* ç¦æ­¢æ»¾å‹• */
            color: white;
            touch-action: none; /* ç¦æ­¢æ‰‹æ©Ÿé è¨­æ‰‹å‹¢ */
            height: 100vh;
            width: 100vw;
            user-select: none;
            -webkit-user-select: none;
        }

        /* æ¨™é¡Œèˆ‡è³‡è¨Š */
        header {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 60px;
            background: rgba(0,0,0,0.3);
            text-align: center;
            z-index: 10;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        h1 { margin: 0; font-size: 1.2rem; color: #f1c40f; }
        p { margin: 2px 0 0; font-size: 0.8rem; color: #ccc; }

        /* äº”å€‹æ’æ§½å€ (è¦–è¦ºèƒŒæ™¯) */
        .slots-container {
            position: absolute;
            top: 70px;
            left: 0;
            width: 100%;
            height: 120px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            z-index: 5;
        }

        .slot {
            width: var(--card-w);
            height: var(--card-h);
            border: 2px dashed var(--slot-border);
            border-radius: 6px;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            background: rgba(0,0,0,0.1);
        }

        .slot-label {
            position: absolute;
            top: -20px;
            font-size: 0.8rem;
            color: #f1c40f;
            font-weight: bold;
        }

        /* æ¡Œé¢å€åŸŸ (è¦–è¦ºèƒŒæ™¯) */
        .table-zone {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 55%; /* ä¸‹åŠéƒ¨æ˜¯æ¡Œé¢ */
            background-image: radial-gradient(#2c6e43, #153821);
            border-top: 2px solid #f1c40f;
            z-index: 1;
        }

        .guide-text {
            position: absolute;
            top: 10px;
            width: 100%;
            text-align: center;
            color: rgba(255,255,255,0.3);
            font-size: 0.9rem;
            pointer-events: none;
        }

        /* å¡ç‰Œæ¨£å¼ */
        .card {
            width: var(--card-w);
            height: var(--card-h);
            position: absolute; /* çµ•å°å®šä½ï¼Œå¯ä»¥åœ¨å…¨è¢å¹•è·‘ */
            border-radius: 6px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.4);
            cursor: grab;
            z-index: 100; /* é è¨­å±¤ç´š */
            
            /* ç‰ŒèƒŒæ¨£å¼ */
            background-color: #b71c1c;
            background-image: repeating-linear-gradient(
                45deg, transparent, transparent 5px, rgba(255,255,255,0.2) 5px, rgba(255,255,255,0.2) 10px
            );
            border: 2px solid #fff;
            
            /* è®“å¡ç‰Œå…§å®¹é è¨­éš±è— */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 0; /* éš±è—æ–‡å­— */
            color: transparent;
        }

        .card:active {
            cursor: grabbing;
            transform: scale(1.1); /* æŒ‰ä½æ™‚ç¨å¾®æ”¾å¤§ */
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
        }

        /* ç¿»ç‰Œå¾Œçš„æ¨£å¼ */
        .card.revealed {
            background: white;
            font-size: 1.5rem; /* é¡¯ç¤ºæ–‡å­— */
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        .card.revealed.red { color: #c0392b; }
        .card.revealed.black { color: #2c3e50; }

        .suit-small { font-size: 0.8rem; position: absolute; top: 2px; left: 2px; }
        .val-large { font-size: 1.8rem; }

        /* æ§åˆ¶æŒ‰éˆ•å€ */
        .controls {
            position: absolute;
            bottom: 20px;
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 15px;
            z-index: 200;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: bold;
            box-shadow: 0 4px 0 rgba(0,0,0,0.3);
            transition: all 0.1s;
        }
        .btn:active { transform: translateY(4px); box-shadow: none; }
        
        .btn-confirm { background: #f1c40f; color: #8e44ad; opacity: 0.5; pointer-events: none; }
        .btn-confirm.active { opacity: 1; pointer-events: auto; animation: pulse 1.5s infinite; }
        .btn-reset { background: #95a5a6; color: white; }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* çµæœé®ç½© */
        #result-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        .final-msg { color: #f1c40f; font-size: 1.5rem; margin-bottom: 10px; }
        .final-amount { font-size: 3.5rem; color: #fff; font-weight: bold; margin: 20px 0; text-shadow: 0 0 20px #e74c3c; }
        .win-btn { padding: 15px 40px; font-size: 1.2rem; background: #e74c3c; color: white; border: none; border-radius: 50px; }

    </style>
</head>
<body>

    <header>
        <h1>ğŸ–ï¸ äº”è·¯è²¡ç¥ (æ‹–æ›³ç‰ˆ)</h1>
        <p>è«‹å°‡å–œæ­¡çš„ç‰Œæ‹–é€²ä¸Šæ–¹æ ¼å­</p>
    </header>

    <div class="slots-container">
        <div class="slot" id="slot-0"><div class="slot-label">è¬</div></div>
        <div class="slot" id="slot-1"><div class="slot-label">åƒ</div></div>
        <div class="slot" id="slot-2"><div class="slot-label">ç™¾</div></div>
        <div class="slot" id="slot-3"><div class="slot-label">å</div></div>
        <div class="slot" id="slot-4"><div class="slot-label">å€‹</div></div>
    </div>

    <div class="table-zone">
        <div class="guide-text">ç”±æ­¤å€æŒ‰ä½ç‰Œï¼Œæ‹–æ›³è‡³ä¸Šæ–¹</div>
    </div>

    <div class="controls">
        <button class="btn btn-reset" onclick="initGame()">é‡æ´—</button>
        <button class="btn btn-confirm" id="confirm-btn" onclick="revealResult()">ç¢ºèªé–‹ç‰Œ</button>
    </div>

    <div id="result-overlay">
        <div class="final-msg">ğŸ§§ æ­å–œç²å¾—ç´…åŒ… ğŸ§§</div>
        <div class="final-amount" id="final-score">$0</div>
        <button class="btn win-btn" onclick="initGame()">å†ä¾†ä¸€æŠŠ</button>
    </div>

    <a href="lobby.html" style="position: absolute; top: 15px; left: 15px; color: rgba(255,255,255,0.5); text-decoration: none; z-index: 200;">&lt; å›å¤§å»³</a>

    <script>
        // è¨­å®š
        const suits = ['â™ ', 'â™¥', 'â™¦', 'â™£'];
        const ranks = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
        
        let cards = []; // å­˜æ”¾æ‰€æœ‰ card å…ƒç´ 
        let slotState = [null, null, null, null, null]; // è¨˜éŒ„å“ªå€‹æ ¼å­æœ‰å“ªå¼µç‰Œ (å­˜ card å…ƒç´ )

        // æ‹–æ›³è®Šæ•¸
        let activeCard = null;
        let startX = 0, startY = 0;
        let initialLeft = 0, initialTop = 0;
        let isDragging = false;

        // åˆå§‹åŒ–
        window.onload = initGame;

        function initGame() {
            // æ¸…é™¤èˆŠç‰Œ
            cards.forEach(c => c.remove());
            cards = [];
            slotState = [null, null, null, null, null];
            document.getElementById('result-overlay').style.display = 'none';
            updateButtonState();

            // ç”¢ç”Ÿ 52 å¼µç‰Œ
            let deckData = createDeckData();
            const tableZone = document.querySelector('.table-zone');
            const tableRect = tableZone.getBoundingClientRect();

            // ç›´æ¥å°‡ç‰ŒåŠ åˆ° bodyï¼Œç¢ºä¿å¯ä»¥è‡ªç”±æ‹–å‹•åˆ°å…¨è¢å¹•ä»»ä½•è§’è½
            deckData.forEach((data, i) => {
                const card = document.createElement('div');
                card.className = 'card';
                card.id = `card-${i}`;
                
                // å­˜å…¥æ•¸æ“š
                card.dataset.suit = data.suit;
                card.dataset.rank = data.rank;
                card.dataset.value = data.value;
                card.dataset.slotIndex = "-1"; // -1 ä»£è¡¨æ²’åœ¨æ ¼å­è£¡

                // éš¨æ©Ÿåˆ†ä½ˆåœ¨ä¸‹æ–¹æ¡Œé¢å€
                // ç‚ºäº†é¿å…å¤ªé é‚Šï¼ŒåŠ ä¸€é» padding
                const maxLeft = window.innerWidth - 60;
                const minTop = tableRect.top + 20;
                const maxTop = window.innerHeight - 90;

                const rLeft = Math.random() * maxLeft;
                const rTop = minTop + Math.random() * (maxTop - minTop);
                const rRot = Math.random() * 60 - 30; // -30 ~ 30åº¦

                card.style.left = `${rLeft}px`;
                card.style.top = `${rTop}px`;
                card.style.transform = `rotate(${rRot}deg)`;

                // ç¶å®šæ‹–æ›³äº‹ä»¶ (Mouse & Touch)
                addDragEvents(card);

                document.body.appendChild(card);
                cards.push(card);
            });
        }

        function createDeckData() {
            let d = [];
            for (let s of suits) {
                for (let r of ranks) {
                    let val = 0;
                    if (r === 'A') val = 1;
                    else if (['10', 'J', 'Q', 'K'].includes(r)) val = 0;
                    else val = parseInt(r);
                    d.push({ suit: s, rank: r, value: val });
                }
            }
            // æ´—ç‰Œ
            for (let i = d.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [d[i], d[j]] = [d[j], d[i]];
            }
            return d;
        }

        // --- æ ¸å¿ƒï¼šæ‹–æ›³é‚è¼¯ ---
        function addDragEvents(el) {
            // è§¸æ§
            el.addEventListener('touchstart', dragStart, {passive: false});
            el.addEventListener('touchmove', dragMove, {passive: false});
            el.addEventListener('touchend', dragEnd);
            // æ»‘é¼ 
            el.addEventListener('mousedown', dragStart);
            document.addEventListener('mousemove', dragMove); // ç¶åœ¨ doc ä¸Šé˜²æ»‘å‡º
            document.addEventListener('mouseup', dragEnd);
        }

        function dragStart(e) {
            // å¦‚æœæ˜¯æ»‘é¼ äº‹ä»¶ï¼Œä½†ç›®æ¨™ä¸æ˜¯å¡ç‰Œï¼ˆæˆ–å¡ç‰Œå·²è¢«é–å®šï¼‰ï¼Œå¿½ç•¥
            if (e.type === 'mousedown' && e.target !== this) return;
            if (this.classList.contains('locked')) return; // é–‹ç‰Œå¾Œä¸èƒ½å‹•

            e.preventDefault();
            activeCard = this;
            isDragging = true;

            // æå‡å±¤ç´šï¼Œç¢ºä¿åœ¨æœ€ä¸Šé¢
            activeCard.style.zIndex = 1000;
            activeCard.style.transition = 'none'; // æ‹–å‹•æ™‚ä¸éœ€è¦å‹•ç•«

            // è¨˜éŒ„åˆå§‹ä½ç½®
            const touch = e.type === 'touchstart' ? e.touches[0] : e;
            startX = touch.clientX;
            startY = touch.clientY;
            initialLeft = parseFloat(activeCard.style.left);
            initialTop = parseFloat(activeCard.style.top);

            // ç¸®å°æ—‹è½‰è§’åº¦ï¼Œè®“æ‹–å‹•æ™‚æ¯”è¼ƒæ­£
            activeCard.style.transform = 'scale(1.1) rotate(0deg)';
            
            // å¦‚æœé€™å¼µç‰ŒåŸæœ¬åœ¨æ ¼å­è£¡ï¼Œå…ˆæ¸…ç©ºè©²æ ¼ç‹€æ…‹
            const oldSlotIdx = parseInt(activeCard.dataset.slotIndex);
            if (oldSlotIdx !== -1) {
                slotState[oldSlotIdx] = null;
                activeCard.dataset.slotIndex = "-1";
                updateButtonState();
            }
        }

        function dragMove(e) {
            if (!isDragging || !activeCard) return;
            e.preventDefault();

            const touch = e.type === 'touchmove' ? e.touches[0] : e;
            const dx = touch.clientX - startX;
            const dy = touch.clientY - startY;

            activeCard.style.left = `${initialLeft + dx}px`;
            activeCard.style.top = `${initialTop + dy}px`;
        }

        function dragEnd(e) {
            if (!isDragging || !activeCard) return;
            isDragging = false;

            activeCard.style.transition = 'all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1)';
            activeCard.style.zIndex = 100; // é‚„åŸå±¤ç´š
            activeCard.style.transform = `scale(1) rotate(${Math.random()*10-5}deg)`; // è¼•å¾®éš¨æ©Ÿæ—‹è½‰

            // æª¢æŸ¥æ˜¯å¦æ”¾é€²æ ¼å­
            checkDrop(activeCard);
            
            activeCard = null;
        }

        function checkDrop(card) {
            const cardRect = card.getBoundingClientRect();
            const cardCenterX = cardRect.left + cardRect.width / 2;
            const cardCenterY = cardRect.top + cardRect.height / 2;

            let droppedInSlot = false;

            // éæ­· 5 å€‹æ ¼å­
            for (let i = 0; i < 5; i++) {
                const slot = document.getElementById(`slot-${i}`);
                const slotRect = slot.getBoundingClientRect();

                // ç°¡å–®çš„ç¢°æ’æª¢æ¸¬ï¼šå¦‚æœå¡ç‰‡ä¸­å¿ƒé»åœ¨æ ¼å­å…§
                if (cardCenterX >= slotRect.left && cardCenterX <= slotRect.right &&
                    cardCenterY >= slotRect.top && cardCenterY <= slotRect.bottom) {
                    
                    // è©²æ ¼æ˜¯å¦å·²æœ‰ç‰Œï¼Ÿ
                    if (slotState[i] === null) {
                        // 1. å¸é™„é€²å»
                        snapToSlot(card, slotRect, i);
                        droppedInSlot = true;
                    } else {
                        // æ ¼å­æœ‰ç‰Œï¼Œæ“ æ‰å®ƒï¼Ÿé‚„æ˜¯å½ˆå›ï¼Ÿé€™è£¡é¸æ“‡å½ˆå›æ¡Œé¢æ¯”è¼ƒç°¡å–®
                        // æˆ–è€…åšäº¤æ›ï¼ˆç¨å¾®è¤‡é›œï¼‰ï¼Œé€™è£¡å…ˆåšå½ˆå›
                    }
                    break;
                }
            }

            if (!droppedInSlot) {
                // å¦‚æœæ²’é€²æ ¼å­ï¼Œä¹Ÿæ²’åœ¨æ¡Œé¢å€ï¼Œæª¢æŸ¥æ˜¯å¦è¦æ­¸ä½ï¼Ÿ
                // é€™è£¡ç°¡å–®è™•ç†ï¼šå¦‚æœé‚„åœ¨è¢å¹•ç¯„åœå…§å°±åœåœ¨åŸåœ°
                // ä½†ç‚ºäº†é«”é©—å¥½ï¼Œå¦‚æœå¡ç‰Œå¤ªé è¿‘ä¸Šæ–¹ä½†æ²’é€²æ ¼ï¼Œæˆ–æ˜¯è¶…å‡ºé‚Šç•Œï¼Œå½ˆå›æ¡Œé¢å€
                const tableZone = document.querySelector('.table-zone');
                const tableRect = tableZone.getBoundingClientRect();
                
                // å¦‚æœæ”¾é–‹çš„ä½ç½®ä¸åœ¨æ¡Œé¢å€ï¼Œä¹Ÿä¸åœ¨æ ¼å­è£¡ -> å½ˆå›éš¨æ©Ÿæ¡Œé¢ä½ç½®
                if (cardCenterY < tableRect.top) {
                     returnToTable(card);
                }
            }
        }

        function snapToSlot(card, slotRect, index) {
            // è¨ˆç®—ä¸­å¿ƒå°é½Šçš„ left/top
            // slotRect æ˜¯ç›¸å°æ–¼è¦–çª—çš„ï¼Œcard æ˜¯ absolute left/top (ç›¸å°æ–¼ body)
            // å› ç‚º body æ˜¯å…¨è¢å¹•ï¼Œæ‰€ä»¥ç›´æ¥ç”¨ slotRect çš„åº§æ¨™
            const newLeft = slotRect.left + (slotRect.width - parseFloat(getComputedStyle(card).width)) / 2;
            const newTop = slotRect.top + (slotRect.height - parseFloat(getComputedStyle(card).height)) / 2;

            card.style.left = `${newLeft}px`;
            card.style.top = `${newTop}px`;
            card.style.transform = 'rotate(0deg)'; // é€²æ ¼å­è¦æ“ºæ­£

            // è¨˜éŒ„ç‹€æ…‹
            slotState[index] = card;
            card.dataset.slotIndex = index;
            
            updateButtonState();
        }

        function returnToTable(card) {
             const tableZone = document.querySelector('.table-zone');
             const tableRect = tableZone.getBoundingClientRect();
             
             const maxLeft = window.innerWidth - 60;
             const minTop = tableRect.top + 20;
             const maxTop = window.innerHeight - 90;

             const rLeft = Math.random() * maxLeft;
             const rTop = minTop + Math.random() * (maxTop - minTop);
             
             card.style.left = `${rLeft}px`;
             card.style.top = `${rTop}px`;
             card.dataset.slotIndex = "-1";
        }

        function updateButtonState() {
            // æª¢æŸ¥æ˜¯å¦ 5 æ ¼éƒ½æœ‰ç‰Œ
            const isFull = !slotState.includes(null);
            const btn = document.getElementById('confirm-btn');
            
            if (isFull) {
                btn.classList.add('active');
                btn.innerText = "ç¢ºèªé–‹ç‰Œ";
            } else {
                btn.classList.remove('active');
                btn.innerText = "è«‹é¸æ»¿äº”å¼µ";
            }
        }

        // --- é–‹ç‰Œé‚è¼¯ ---
        function revealResult() {
            if (slotState.includes(null)) return; // é˜²å‘†

            // é–å®šæ‰€æœ‰å¡ç‰Œä¸èƒ½å‹•
            cards.forEach(c => c.classList.add('locked'));
            document.getElementById('confirm-btn').classList.remove('active');
            
            let totalAmountStr = "";

            // ä¾åºç¿»ç‰Œ
            slotState.forEach((card, i) => {
                setTimeout(() => {
                    // è¦–è¦ºç¿»è½‰
                    card.classList.add('revealed');
                    const isRed = (card.dataset.suit === 'â™¥' || card.dataset.suit === 'â™¦');
                    card.classList.add(isRed ? 'red' : 'black');
                    
                    // é¡¯ç¤ºå…§å®¹
                    card.innerHTML = `
                        <div class="suit-small">${card.dataset.suit}</div>
                        <div class="val-large">${card.dataset.rank}</div>
                    `;
                    
                    totalAmountStr += card.dataset.value;

                    // æœ€å¾Œä¸€å¼µç¿»å®Œ
                    if (i === 4) {
                        showFinalScore(parseInt(totalAmountStr));
                    }
                }, i * 300);
            });
        }

        function showFinalScore(amount) {
            setTimeout(() => {
                const overlay = document.getElementById('result-overlay');
                overlay.style.display = 'flex';
                const scoreEl = document.getElementById('final-score');
                scoreEl.innerText = `$${amount.toLocaleString()}`;
            }, 500);
        }

    </script>
</body>
</html>
